<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lucet</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="Overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="Using-lucet.html"><strong aria-hidden="true">2.</strong> Using Lucet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Compiling.html"><strong aria-hidden="true">2.1.</strong> Compiling Lucet</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="Compiling-on-Linux.html"><strong aria-hidden="true">2.1.1.</strong> Compiling on Linux</a></li><li class="chapter-item expanded "><a href="Compiling-on-macOS.html"><strong aria-hidden="true">2.1.2.</strong> Compiling on macOS</a></li></ol></li><li class="chapter-item expanded "><a href="Your-first-Lucet-application.html"><strong aria-hidden="true">2.2.</strong> Lucet &quot;Hello World&quot;</a></li><li class="chapter-item expanded "><a href="lucet-runtime-example.html"><strong aria-hidden="true">2.3.</strong> Using the Lucet runtime API from Rust</a></li><li class="chapter-item expanded "><a href="Integrity-and-authentication.html"><strong aria-hidden="true">2.4.</strong> Module integrity and authentication</a></li></ol></li><li class="chapter-item expanded "><a href="Lucet-components.html"><strong aria-hidden="true">3.</strong> Lucet components</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lucetc.html"><strong aria-hidden="true">3.1.</strong> lucetc</a></li><li class="chapter-item expanded "><a href="lucet-runtime.html"><strong aria-hidden="true">3.2.</strong> lucet-runtime</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="lucet-runtime/killswitch.html"><strong aria-hidden="true">3.2.1.</strong> KillSwitch</a></li></ol></li><li class="chapter-item expanded "><a href="lucet-wasi.html"><strong aria-hidden="true">3.3.</strong> lucet-wasi</a></li><li class="chapter-item expanded "><a href="lucet-objdump.html"><strong aria-hidden="true">3.4.</strong> lucet-objdump</a></li><li class="chapter-item expanded "><a href="lucet-spectest.html"><strong aria-hidden="true">3.5.</strong> lucet-spectest</a></li><li class="chapter-item expanded "><a href="lucet-wasi-sdk.html"><strong aria-hidden="true">3.6.</strong> lucet-wasi-sdk</a></li><li class="chapter-item expanded "><a href="lucet-module.html"><strong aria-hidden="true">3.7.</strong> lucet-module</a></li><li class="chapter-item expanded "><a href="Tests-and-benchmarks.html"><strong aria-hidden="true">3.8.</strong> Tests and benchmarks</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="sightglass.html"><strong aria-hidden="true">3.8.1.</strong> sightglass</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="versioning_releasing.html"><strong aria-hidden="true">4.</strong> Versioning and releasing to crates.io</a></li><li class="chapter-item expanded "><a href="Security.html"><strong aria-hidden="true">5.</strong> Security</a></li><li class="chapter-item expanded "><a href="CHANGELOG.html"><strong aria-hidden="true">6.</strong> Changelog</a></li><li class="chapter-item expanded "><a href="License.html"><strong aria-hidden="true">7.</strong> License</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Lucet</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        <a href="https://github.com/bytecodealliance/lucet" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#lucet---a-hrefhttpsgithubcombytecodealliancelucetactionsqueryworkflow3aciimg-srchttpsgithubcombytecodealliancelucetworkflowscibadgesvg-altbuild-status-a" id="lucet---a-hrefhttpsgithubcombytecodealliancelucetactionsqueryworkflow3aciimg-srchttpsgithubcombytecodealliancelucetworkflowscibadgesvg-altbuild-status-a">Lucet   <a href="https://github.com/bytecodealliance/lucet/actions?query=workflow%3ACI"><img src="https://github.com/bytecodealliance/lucet/workflows/CI/badge.svg" alt="Build Status" /></a></a></h1>
<p><strong>A <a href="https://bytecodealliance.org/">Bytecode Alliance</a> project</strong></p>
<p><strong>Lucet is a native WebAssembly compiler and runtime. It is designed
to safely execute untrusted WebAssembly programs inside your application.</strong></p>
<p>Check out our <a href="https://www.fastly.com/blog/announcing-lucet-fastly-native-webassembly-compiler-runtime">announcement post on the Fastly blog</a>.</p>
<p>Lucet uses, and is developed in collaboration with, the Bytecode Alliance's
<a href="http://github.com/bytecodealliance/cranelift">Cranelift</a> code generator. It powers Fastly's
<a href="https://wasm.fastlylabs.com">Terrarium</a> platform.</p>
<p><a href="https://asciinema.org/a/249302"><img src="https://asciinema.org/a/249302.svg" alt="asciicast" /></a></p>
<p>Lucet's documentation is available at <a href="https://bytecodealliance.github.io/lucet">https://bytecodealliance.github.io/lucet</a>
(<a href="https://github.com/bytecodealliance/lucet/tree/main/docs">sources</a>).</p>
<h2><a class="header" href="#getting-started" id="getting-started">Getting started</a></h2>
<p>To learn how to set up the toolchain, and then compile and run your first WebAssembly application
using Lucet, see <a href="./Getting-started.html">Getting started</a>.</p>
<h2><a class="header" href="#development-environment" id="development-environment">Development environment</a></h2>
<p>Lucet is developed and tested on x86-64 Linux, with experimental support for macOS. For compilation
instructions, see <a href="./Compiling.html">Compiling</a>.</p>
<h2><a class="header" href="#supported-languages-and-platforms" id="supported-languages-and-platforms">Supported languages and platforms</a></h2>
<p>Lucet supports running WebAssembly programs written in C and C++ (via <code>clang</code>), Rust, and
AssemblyScript. It does not yet support the entire WebAssembly spec, but full support is
<a href="./lucet-spectest.html">planned</a>.</p>
<p>Lucet's runtime currently supports x86-64 based Linux systems, with experimental support for macOS.</p>
<h2><a class="header" href="#security" id="security">Security</a></h2>
<p>The Lucet project aims to provide support for secure execution of untrusted code. Security is
achieved through a combination of Lucet-supplied security controls and user-supplied security
controls. See <a href="./Security.html">Security</a> for more information on the Lucet security model.</p>
<h3><a class="header" href="#reporting-security-issues" id="reporting-security-issues">Reporting Security Issues</a></h3>
<p>The Lucet project team welcomes security reports and is committed to providing prompt attention to
security issues. Security issues should be reported privately via <a href="https://www.fastly.com/security/report-security-issue">Fastly’s security issue reporting
process</a>. Remediation of security
vulnerabilities is prioritized. The project teams endeavors to coordinate remediation with
third-party stakeholders, and is committed to transparency in the disclosure process.</p>
<h1><a class="header" href="#using-lucet" id="using-lucet">Using Lucet</a></h1>
<p>To get started using Lucet, you will need to <a href="./Compiling.html">compile and install Lucet</a>.</p>
<p>Once the Lucet command-line tools are available, you can <a href="./Your-first-Lucet-application.html">run a Lucet &quot;Hello World&quot;
application</a>, or use the <a href="./lucet-runtime-example.html"><code>lucet-runtime</code>
API</a> to embed a Lucet program in your Rust application.</p>
<h1><a class="header" href="#compiling-lucet-from-scratch" id="compiling-lucet-from-scratch">Compiling Lucet from scratch</a></h1>
<p>Specific instructions are available for <a href="./Compiling-on-Linux.html">some flavors of Linux</a> and for
<a href="./Compiling-on-macOS.html">macOS</a> (experimental).</p>
<p>If you are using another platform, or if the provided instructions are not working, it may be
helpful to try adapting the setup code in the <code>Dockerfile</code> that defines the Lucet continuous
integration environment. While the image is defined in terms of Ubuntu 18.04, many of the
packages are available through other package managers and operating systems.</p>
<h1><a class="header" href="#compiling-on-linux" id="compiling-on-linux">Compiling on Linux</a></h1>
<p>We successfully compiled Lucet on Arch Linux, Fedora, Gentoo and Ubuntu. Only x86_64 CPUs are
supported at this time.</p>
<h2><a class="header" href="#option-1-installation-on-ubuntu-with-a-sidecar-installation-of-llvmclang" id="option-1-installation-on-ubuntu-with-a-sidecar-installation-of-llvmclang">Option 1: installation on Ubuntu, with a sidecar installation of LLVM/clang</a></h2>
<p>The following instructions only work on Ubuntu. They install a recent version of LLVM and <code>clang</code>
(in <code>/opt/wasi-sdk</code>), so that WebAssembly code can be compiled on Ubuntu versions older than 19.04.</p>
<p>First, the <code>curl</code> and <code>cmake</code> packages must be installed:</p>
<pre><code class="language-sh">apt install curl ca-certificates cmake
</code></pre>
<p>You will need to install <code>wasi-sdk</code> as well. Note that you may need to run <code>dpkg</code> with elevated
privileges to install the package.</p>
<pre><code class="language-sh">curl -sS -L -O https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-10/wasi-sdk_10.0_amd64.deb \
    &amp;&amp; dpkg -i wasi-sdk_10.0_amd64.deb &amp;&amp; rm -f wasi-sdk_10.0_amd64.deb
</code></pre>
<p>Install the latest stable version of the Rust compiler:</p>
<pre><code class="language-sh">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
</code></pre>
<p>Enter your clone of the Lucet repository, and then fetch/update the submodules:</p>
<pre><code class="language-sh">cd lucet

git submodule update --init --recursive
</code></pre>
<p>Finally, compile the toolchain:</p>
<pre><code class="language-sh">make install
</code></pre>
<p>In order to use <code>clang</code> to compile WebAssembly code, you need to adjust your <code>PATH</code> to use tools
from <code>/opt/wasi-sdk/bin</code> instead of the system compiler. Or use set of commands prefixed by
<code>wasm-wasi-</code>, such as <code>wasm32-wasi-clang</code> instead of <code>clang</code>.</p>
<h2><a class="header" href="#option-2-installation-on-a-recent-linux-system-using-the-base-compiler" id="option-2-installation-on-a-recent-linux-system-using-the-base-compiler">Option 2: installation on a recent Linux system, using the base compiler</a></h2>
<p>Support for WebAssembly was introduced in LLVM 8, released in March 2019.</p>
<p>As a result, Lucet can be compiled with an existing LLVM installation, provided that it is up to
date. Most distributions now include LLVM &gt;= 8, so that an additional installation is not
required to compile to WebAssembly .</p>
<p>On distributions such as Ubuntu (19.04 or newer) and Debian (bullseye or newer), the following
command installs the prerequisites:</p>
<pre><code class="language-sh">apt install curl ca-certificates clang lld cmake
</code></pre>
<p>On Arch Linux:</p>
<pre><code class="language-sh">pacman -S curl clang lld cmake
</code></pre>
<p>Next, install the WebAssembly compiler builtins:</p>
<pre><code class="language-sh">curl -sL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-10/libclang_rt.builtins-wasm32-wasi-10.0.tar.gz | \
  sudo tar x -zf - -C /usr/lib/llvm-*/lib/clang/*
</code></pre>
<p>Install the latest stable version of the Rust compiler:</p>
<pre><code class="language-sh">curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
</code></pre>
<p>Install the WASI sysroot:</p>
<pre><code class="language-sh">mkdir -p /opt
curl -L https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-10/wasi-sdk-10.0-linux.tar.gz | \
sudo tar x -zv -C /opt -f - wasi-sdk-10.0/share &amp;&amp; \
  sudo ln -s /opt/wasi-sdk-*/share/wasi-sysroot /opt/wasi-sysroot
</code></pre>
<p>Enter your clone of the Lucet repository, and then fetch/update the submodules:</p>
<pre><code class="language-sh">cd lucet

git submodule update --init --recursive
</code></pre>
<p>Set the <code>LLVM</code> path:</p>
<pre><code class="language-sh">export LLVM_BIN=/usr/lib/llvm-*/bin
</code></pre>
<p>Finally, install the Lucet toolchain with:</p>
<pre><code class="language-sh">make install
</code></pre>
<p>and update your shell's environment variables:</p>
<pre><code class="language-sh">source /opt/lucet/bin/setenv.sh
</code></pre>
<p>You may want to add these environment variables to your shell's configuration.</p>
<p>The standard system compiler can be used to compile to WebAssembly, simply by adding
<code>--host=wasm32-wasi</code> to the compilation flags.</p>
<h1><a class="header" href="#compiling-on-macos" id="compiling-on-macos">Compiling on macOS</a></h1>
<h2><a class="header" href="#prerequisites" id="prerequisites">Prerequisites</a></h2>
<p>Install <code>llvm</code>, <code>rust</code> and <code>cmake</code> using <a href="https://brew.sh">Homebrew</a>:</p>
<pre><code class="language-sh">brew install llvm rust cmake
</code></pre>
<p>In order to compile applications written in C to WebAssembly, <code>clang</code> builtins need to be installed:</p>
<pre><code class="language-sh">curl -sL https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-10/libclang_rt.builtins-wasm32-wasi-10.0.tar.gz | \
  tar x -zf - -C /usr/local/opt/llvm/lib/clang/10*
</code></pre>
<p>As well as the WASI sysroot:</p>
<pre><code class="language-sh">sudo mkdir -p /opt

curl -sS -L https://github.com/WebAssembly/wasi-sdk/releases/download/wasi-sdk-10/wasi-sysroot-10.0.tar.gz | \
  sudo tar x -zf - -C /opt
</code></pre>
<h2><a class="header" href="#compiling-and-installing-lucet" id="compiling-and-installing-lucet">Compiling and installing Lucet</a></h2>
<p>Enter the Lucet git repository clone, and fetch/update the submodules:</p>
<pre><code class="language-sh">cd lucet

git submodule update --init
</code></pre>
<p>Define the location of the WASI sysroot installation:</p>
<pre><code class="language-sh">export WASI_SYSROOT=/opt/wasi-sysroot
</code></pre>
<p>Finally, compile and install the toolchain:</p>
<pre><code class="language-sh">env LUCET_PREFIX=/opt/lucet make install
</code></pre>
<p>Change <code>LUCET_PREFIX</code> to the directory you would like to install Lucet into. <code>/opt/lucet</code> is the default directory.</p>
<h2><a class="header" href="#setting-up-the-environment" id="setting-up-the-environment">Setting up the environment</a></h2>
<p>In order to add <code>/opt/lucet</code> to the command search path, as well register the library path for the Lucet runtime, the following command can be run interactively or added to the shell startup files:</p>
<pre><code class="language-sh">source /opt/lucet/bin/setenv.sh
</code></pre>
<h2><a class="header" href="#running-the-test-suite" id="running-the-test-suite">Running the test suite</a></h2>
<p>If you want to run the test suite, and in addition to <code>WASI_SYSROOT</code>, the following environment variables must be set:</p>
<pre><code class="language-sh">export CLANG_ROOT=&quot;$(echo /usr/local/opt/llvm/lib/clang/10*)&quot;
export CLANG=/usr/local/opt/llvm/bin/clang
</code></pre>
<p>And the test suite can then be run with the following command:</p>
<pre><code class="language-sh">make test
</code></pre>
<h1><a class="header" href="#your-first-lucet-application" id="your-first-lucet-application">Your first Lucet application</a></h1>
<p>Ensure the Lucet command-line tools are <a href="./Compiling.html">installed on your machine</a></p>
<p>Create a new work directory in the <code>lucet</code> directory:</p>
<pre><code class="language-sh">mkdir -p src/hello

cd src/hello
</code></pre>
<p>Save the following C source code as <code>hello.c</code>:</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

int main(void)
{
    puts(&quot;Hello world&quot;);
    return 0;
}
</code></pre>
<p>Time to compile to WebAssembly! The development environment includes a version of the Clang
toolchain that is built to generate WebAssembly by default. The related commands are accessible from
your current shell, and are prefixed by <code>wasm32-wasi-</code>.</p>
<p>For example, to create a WebAssembly module <code>hello.wasm</code> from <code>hello.c</code>:</p>
<pre><code class="language-sh">wasm32-wasi-clang -Ofast -o hello.wasm hello.c
</code></pre>
<p>The next step is to use Lucet to build native <code>x86_64</code> code from that WebAssembly file:</p>
<pre><code class="language-sh">lucetc-wasi -o hello.so hello.wasm
</code></pre>
<p><code>lucetc</code> is the WebAssembly to native code compiler. The <code>lucetc-wasi</code> command runs the same
compiler, but automatically configures it to target WASI.</p>
<p><code>hello.so</code> is created and ready to be run:</p>
<pre><code class="language-sh">lucet-wasi hello.so
</code></pre>
<h1><a class="header" href="#example-usage-of-the-lucet-runtime-crate" id="example-usage-of-the-lucet-runtime-crate">Example usage of the <code>lucet-runtime</code> crate.</a></h1>
<p>The following Rust code loads a WebAssembly module compiled using <code>lucetc-wasi</code> and calls its
<code>main()</code> function.</p>
<h2><a class="header" href="#cargoconfig" id="cargoconfig"><code>.cargo/config</code>:</a></h2>
<p>These flags must be set in order to have symbols from the runtime properly exported.</p>
<pre><code class="language-toml">[build]
rustflags = [&quot;-C&quot;, &quot;link-args=-rdynamic&quot;]
</code></pre>
<h2><a class="header" href="#cargotoml" id="cargotoml"><code>Cargo.toml</code>:</a></h2>
<pre><code class="language-toml">[package]
name = &quot;lucet-runtime-example&quot;
version = &quot;0.1.0&quot;
edition = &quot;2018&quot;

[dependencies]
lucet-runtime = { path = &quot;../../lucet-runtime&quot; }
lucet-wasi = { path = &quot;../../lucet-wasi&quot; }

# or, if compiling against released crates.io versions:
# lucet-runtime = &quot;0.5.1&quot;
# lucet-wasi = &quot;0.5.1&quot;
</code></pre>
<h2><a class="header" href="#srcmainrs" id="srcmainrs"><code>src/main.rs</code>:</a></h2>
<pre><pre class="playground"><code class="language-rust">use lucet_runtime::{DlModule, Limits, MmapRegion, Region};
use lucet_wasi::WasiCtxBuilder;

fn main() {
    // ensure the WASI symbols are exported from the final executable
    lucet_wasi::export_wasi_funcs();
    // load the compiled Lucet module
    let dl_module = DlModule::load(&quot;example.so&quot;).unwrap();
    // create a new memory region with default limits on heap and stack size
    let region = MmapRegion::create(1, &amp;Limits::default()).unwrap();
    // instantiate the module in the memory region
    let mut instance = region.new_instance(dl_module).unwrap();
    // prepare the WASI context, inheriting stdio handles from the host executable
    let wasi_ctx = WasiCtxBuilder::new().inherit_stdio().build().unwrap();
    instance.insert_embed_ctx(wasi_ctx);
    // run the WASI main function
    instance.run(&quot;main&quot;, &amp;[]).unwrap();
}
</code></pre></pre>
<h1><a class="header" href="#end-to-end-integrity-and-authentication-of-lucet-assets" id="end-to-end-integrity-and-authentication-of-lucet-assets">End-to-end integrity and authentication of Lucet assets</a></h1>
<p>Lucet tools have the ability to verify digital signatures of their input, and produce signed output, ensuring continuous trust even if assets have to transit over unsecured networks.</p>
<ul>
<li><code>lucetc</code> can be configured to only compile source code (<code>.wasm</code>, <code>.wat</code> files) if a signature is present, and can be verified using a pre-configured public key.</li>
<li>Shared libraries produced by the <code>lucetc</code> compiler can themselves embed a signature, computed using the same secret key as the source code, or a different key.</li>
<li>The <code>lucet-wasi</code> runtime can accept to run native code from <code>lucetc</code> only if it embeds a valid signature for a pre-configured public key.</li>
</ul>
<p>Secret keys can be protected by a password for interactive use, or be password-less for automation.</p>
<p><a href="https://jedisct1.github.io/minisign/">Minisign</a> is the highly secure signature system used in Lucet via the <a href="https://crates.io/crates/minisign">minisign crate</a>. Key pairs and signatures are fully compatible with other implementations.</p>
<h2><a class="header" href="#lucetc-signature-verification" id="lucetc-signature-verification">Lucetc signature verification</a></h2>
<p>Source files (<code>.wasm</code>, <code>.wat</code>) can be signed with <a href="https://jedisct1.github.io/minisign/"><code>minisign</code></a>, <a href="https://github.com/jedisct1/rsign2"><code>rsign2</code></a>, or another Minisign implementation.</p>
<p>The Lucet container ships with <code>rsign2</code> preinstalled.</p>
<h3><a class="header" href="#creating-a-new-key-pair" id="creating-a-new-key-pair">Creating a new key pair</a></h3>
<pre><code class="language-sh">rsign generate
</code></pre>
<pre><code class="language-text">Please enter a password to protect the secret key.
Password:
Password (one more time):
Deriving a key from the password in order to encrypt the secret key... done

The secret key was saved as /Users/j/.rsign/rsign.key - Keep it secret!
The public key was saved as rsign.pub - That one can be public.

Files signed using this key pair can be verified with the following command:

rsign verify &lt;file&gt; -P RWRJwC2NawX3xnBK6mvAAehmFWQ6Z1PLXoyIz78LYkLsklDdaeHEcAU5
</code></pre>
<h3><a class="header" href="#signing-a-webassembly-input-file" id="signing-a-webassembly-input-file">Signing a WebAssembly input file</a></h3>
<pre><code class="language-sh">rsign sign example.wasm
</code></pre>
<pre><code class="language-text">Password:
Deriving a key from the password and decrypting the secret key... done
</code></pre>
<p>The resulting signature is stored into a file with the same name as the file having been signed, with a <code>.minisig</code> suffix (in the example above: <code>example.wasm.minisig</code>).</p>
<h3><a class="header" href="#configuring-lucetc-to-verify-signatures" id="configuring-lucetc-to-verify-signatures">Configuring lucetc to verify signatures</a></h3>
<p>Source files can be verified by adding the following command-line switches to <code>lucetc</code>.</p>
<pre><code class="language-text">--signature-verify
--signature-pk=&lt;path to the public key file&gt;
</code></pre>
<p><code>lucetc</code> assumes that a source file and its signature are in the same directory.</p>
<p>Compilation will only start if the signature is valid for the given public key.</p>
<h2><a class="header" href="#producing-signed-shared-objects" id="producing-signed-shared-objects">Producing signed shared objects</a></h2>
<p>Shared libraries produced by the <code>lucetc</code> compiler can embed a signature.</p>
<h3><a class="header" href="#creating-a-key-pair" id="creating-a-key-pair">Creating a key pair</a></h3>
<p>This requires a secret key, that can be either created using a 3rd party minisign implementation, or by <code>lucetc</code> itself:</p>
<pre><code class="language-sh">lucetc --signature-keygen \
  --signature-sk &lt;file to store the secret key into&gt; \
  --signature-pk &lt;file to store the public key into&gt;
</code></pre>
<p>By default, secret keys are protected by a password. If this is inconvenient, <code>lucetc</code> also supports <code>raw</code>, unencrypted secret keys.
In order to use raw keys, add a <code>raw:</code> prefix before the file name (ex: <code>--signature-sk=raw:/opt/etc/lucet.key</code>).</p>
<h3><a class="header" href="#signing-shared-objects-produced-by-lucetc" id="signing-shared-objects-produced-by-lucetc">Signing shared objects produced by lucetc</a></h3>
<p>In order to embed a signature in a shared object produced by <code>lucetc</code> or <code>lucetc-wasi</code>, the following command-line switches should be present:</p>
<pre><code class="language-text">--signature-create
--signature-sk &lt;path to the secret key file&gt;
</code></pre>
<p>If the secret key was encrypted with a password, the password will be asked interactively.</p>
<p>Signatures are directly stored in the <code>.so</code> or <code>.dylib</code> files.</p>
<p>Key pairs used for source verification and for signing compiled objects can be different, and both operations are optional.</p>
<h2><a class="header" href="#signature-verification-in-the-lucet-runtime" id="signature-verification-in-the-lucet-runtime">Signature verification in the Lucet runtime</a></h2>
<p><code>lucet-wasi</code> can be configured to run only trusted native code, that includes a valid signature for a pre-configured key. In order to do so, the following command-line switches have to be present:</p>
<pre><code class="language-text">--signature-verify
--signature-pk &lt;path to the public key file&gt;
</code></pre>
<h1><a class="header" href="#lucet-components" id="lucet-components">Lucet components</a></h1>
<ul>
<li>
<p><a href="lucetc.html"><code>lucetc</code></a>: the Lucet Compiler.</p>
</li>
<li>
<p><a href="lucet-runtime.html"><code>lucet-runtime</code></a>: the runtime for WebAssembly modules compiled through
<code>lucetc</code>.</p>
</li>
<li>
<p><a href="./lucet-wasi.html"><code>lucet-wasi</code></a>: runtime support for the <a href="https://wasi.dev">WebAssembly System Interface
(WASI)</a>.</p>
</li>
<li>
<p><a href="./lucet-objdump.html"><code>lucet-objdump</code></a>: an executable for inspecting the contents of a shared
object generated by <code>lucetc</code>.</p>
</li>
<li>
<p><a href="./lucet-spectest.html"><code>lucet-spectest</code></a>: a driver for running the official WebAssembly spec test
suite under Lucet.</p>
</li>
<li>
<p><a href="./lucet-wasi-sdk.html"><code>lucet-wasi-sdk</code></a>: convenient wrappers around the WASI Clang toolchain and
<code>lucetc</code>.</p>
</li>
<li>
<p><a href="./lucet-module.html"><code>lucet-module</code></a>: data structure definitions and serialization functions that
we emit into shared objects with <code>lucetc</code>, and read with <code>lucet-runtime</code>.</p>
</li>
</ul>
<h1><a class="header" href="#lucetc---a-hrefhttpsdocsrslucetcimg-srchttpsdocsrslucetcbadgesvg-altdocs-badge-a" id="lucetc---a-hrefhttpsdocsrslucetcimg-srchttpsdocsrslucetcbadgesvg-altdocs-badge-a"><code>lucetc</code>   <a href="https://docs.rs/lucetc"><img src="https://docs.rs/lucetc/badge.svg" alt="docs-badge" /></a></a></h1>
<p><code>lucetc</code> is the Lucet Compiler.</p>
<p>The Rust crate <code>lucetc</code> provides an executable <code>lucetc</code>.</p>
<p>It compiles WebAssembly modules (<code>.wasm</code> or <code>.wat</code> files) into native code (<code>.o</code> or <code>.so</code> files).</p>
<h2><a class="header" href="#example" id="example">Example</a></h2>
<pre><code class="language-sh">lucetc example.wasm --output example.so --bindings lucet-wasi/bindings.json --reserved-size 64MiB --opt-level best
</code></pre>
<p>This command compiles <code>example.wasm</code>, a WebAssembly module, into a shared library <code>example.so</code>. At
run time, the heap can grow up to 64 MiB.</p>
<p>Lucetc can produce ELF (on Linux) and Mach-O (on macOS) objects and libraries. For debugging
purposes or code analysis, it can also dump Cranelift code.</p>
<h2><a class="header" href="#usage" id="usage">Usage</a></h2>
<pre><code class="language-text">    lucetc [FLAGS] [OPTIONS] [--] [input]

FLAGS:
        --count-instructions    Instrument the produced binary to count the number of wasm operations the translated
                                program executes
    -h, --help                  Prints help information
        --signature-keygen      Create a new key pair
        --signature-create      Sign the object file
    -V, --version               Prints version information
        --signature-verify      Verify the signature of the source file

OPTIONS:
        --bindings &lt;bindings&gt;...                   path to bindings json file
        --emit &lt;emit&gt;
            type of code to generate (default: so) [possible values: obj, so, clif]

        --guard-size &lt;guard_size&gt;                  size of linear memory guard. must be multiple of 4k. default: 4 MiB
        --max-reserved-size &lt;max_reserved_size&gt;
            maximum size of usable linear memory region. must be multiple of 4k. default: 4 GiB

        --min-reserved-size &lt;min_reserved_size&gt;
            minimum size of usable linear memory region. must be multiple of 4k. default: 4 MiB

        --opt-level &lt;opt_level&gt;
            optimization level (default: 'speed_and_size'). 0 is alias to 'none', 1 to 'speed', 2 to 'speed_and_size'
            [possible values: 0, 1, 2, none, speed, speed_and_size]
    -o, --output &lt;output&gt;                          output destination, defaults to a.out if unspecified
        --signature-pk &lt;pk_path&gt;                   Path to the public key to verify the source code signature
        --precious &lt;precious&gt;                      directory to keep intermediate build artifacts in
        --reserved-size &lt;reserved_size&gt;
            exact size of usable linear memory region, overriding --{min,max}-reserved-size. must be multiple of 4k

        --signature-sk &lt;sk_path&gt;
            Path to the secret key to sign the object file. The file can be prefixed with &quot;raw:&quot; in order to store a
            raw, unencrypted secret key

ARGS:
    &lt;input&gt;    input file

</code></pre>
<h2><a class="header" href="#external-symbols" id="external-symbols">External symbols</a></h2>
<p>By default, compiled files cannot call any external function. Not even WASI's. Allowed external
functions have to be explicitly listed in bindings JSON file, that have the following format:</p>
<pre><code class="language-json">{
    &quot;wasi_unstable&quot;: {
        &quot;symbol_name_1&quot;: &quot;native_symbol_name_1&quot;,
        &quot;symbol_name_n&quot;: &quot;native_symbol_name_n&quot;,
    }
}
</code></pre>
<p>The example above allows the WebAssembly module to refer to an external symbol <code>symbol_name_1</code>, that
maps to the native symbol <code>native_symbol_name_1</code>.</p>
<p>The <code>--bindings</code> command-line switch can be used more than once in order to split the definitions
into multiple files.</p>
<p>When using WASI, the <code>bindings.json</code> file shipped with <code>lucet-wasi</code> can be used in order to import
all the symbols available in the <code>lucet-wasi</code> runtime.</p>
<h2><a class="header" href="#memory-limits" id="memory-limits">Memory limits</a></h2>
<ul>
<li>
<p><code>--max-reserved-size &lt;size&gt;</code> makes the compiler assume that the heap will never grow more than
<code>&lt;size&gt;</code> bytes. The compiler will generate code optimized for that size, inserting bound checks
with static values whenever necessary. As a side effect, the module will trap if the limit is ever
reached, even if the runtime could allow the heap to grow even further.</p>
</li>
<li>
<p><code>--min-reserved-size &lt;size&gt;</code> sets the maximum heap size the runtime should use.</p>
</li>
<li>
<p><code>--reserved-size &lt;size&gt;</code> is a shortcut to set both values simultaneously, and is the recommended
way to configure how much memory the module can use. The default is only 4 MiB, so this is
something you may want to increase.</p>
</li>
<li>
<p><code>--guard-size &lt;size&gt;</code> controls how much virtual memory with no read nor write access is reserved
after an instance's heap. The compiler can avoid some bound checking when it is safe to do so
according to this value.</p>
</li>
</ul>
<h2><a class="header" href="#optimization-levels" id="optimization-levels">Optimization levels</a></h2>
<ul>
<li>
<p><code>--opt-level 0</code> makes the compilation as fast as possible, but the resulting code itself may not
be optimal.</p>
</li>
<li>
<p><code>--opt-level 1</code> generates fast code, but does not run passes intended to reduce code size.</p>
</li>
<li>
<p><code>--opt-level 2</code> generates the fastest and smallest, but is compilation is about twice as slow as
<code>0</code>.</p>
</li>
</ul>
<h1><a class="header" href="#lucet-runtime---a-hrefhttpsdocsrslucet-runtimeimg-srchttpsdocsrslucet-runtimebadgesvg-altdocs-badge-a" id="lucet-runtime---a-hrefhttpsdocsrslucet-runtimeimg-srchttpsdocsrslucet-runtimebadgesvg-altdocs-badge-a"><code>lucet-runtime</code>   <a href="https://docs.rs/lucet-runtime"><img src="https://docs.rs/lucet-runtime/badge.svg" alt="docs-badge" /></a></a></h1>
<p><code>lucet-runtime</code> is the runtime for WebAssembly modules compiled through <code>lucetc</code>.</p>
<p>It is a Rust crate that provides the functionality to load modules from shared object files,
instantiate them, and call exported WebAssembly functions. <code>lucet-runtime</code> manages the resources
used by each WebAssembly instance (linear memory &amp; globals), and the exception mechanisms that
detect and recover from illegal operations.</p>
<p>The public API of the library is defined <code>lucet-runtime</code>, but the bulk of the implementation is in
the child crate <code>lucet-runtime-internals</code>. Proc macros are defined in <code>lucet-runtime-macros</code>, and
test suites are defined in the child crate <code>lucet-runtime-tests</code>. Many of these tests invoke
<code>lucetc</code> and the <code>wasi-sdk</code> tools.</p>
<p><code>lucet-runtime</code> is usable as a Rust crate or as a C library. The C language interface is found at
<code>lucet-runtime/include/lucet.h</code>.</p>
<h1><a class="header" href="#killswitch" id="killswitch"><code>KillSwitch</code></a></h1>
<p><code>KillSwitch</code> is a mechanism by which users of <code>lucet-runtime</code> can
asynchronously request, very sternly, that an <code>lucet_runtime::Instance</code> be
disabled from running.</p>
<p>If the instance is currently running, it will be stopped as soon as possible.
If the instance has not yet started running, it will immediately exit with
an error when the <code>lucet</code> embedder attempts to run it.</p>
<p><code>KillSwitch</code> easily interoperates with Lucet's instance suspend/resume
machinery: suspending an instance is, from the instance's point of view, just a
(possibly very long) hostcall. Termination of a suspended instance behaves like
termination in any other hostcall: witnessed when the instance is resumed and
the &quot;hostcall&quot; exits.</p>
<p>In some circumstances, a <code>KillSwitch</code> may successfully fire to no actual effect
at any point in the program - one such example is termination in a hostcall that
eventually faults; since termination cannot preempt hostcalls, the termination may
never be witnessed if the fault causes the host to never resume the Lucet
instance.</p>
<p>In this chapter we will describe a typical usage of <code>KillSwitch</code> as a mechanism
to enforce execution time limits. Then, we will discuss the implementation
complexities that <code>KillSwitch</code> must address to be correct.</p>
<p><code>KillSwitch</code> are valid for termination only on the instance call after they are
created, or until an instance is reset. When a call into a guest returns, the
shared state by which <code>KillSwitch</code> signal is replaced, and an attempt to
<code>terminate</code> will fail with an <code>Err</code>.</p>
<h2><a class="header" href="#example-killswitch-used-as-a-timeout-mechanism" id="example-killswitch-used-as-a-timeout-mechanism">Example: <code>KillSwitch</code> used as a timeout mechanism</a></h2>
<p>This example is taken from <code>lucet_runtime_tests::timeout::timeout_in_guest</code>:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let module = mock_timeout_module();
let region = &lt;TestRegion as RegionCreate&gt;::create(1, &amp;Limits::default())
    .expect(&quot;region can be created&quot;);
let mut inst = region
    .new_instance(module)
    .expect(&quot;instance can be created&quot;);
let kill_switch = inst.kill_switch();

// Spawn a thread to terminate the instance after waiting for 100ms.
let t = thread::Builder::new()
    .name(&quot;killswitch&quot;.to_owned())
    .spawn(move || {
        thread::sleep(Duration::from_millis(100));
        assert_eq!(kill_switch.terminate(), Ok(KillSuccess::Signalled));
    })
    .expect(&quot;can spawn a thread&quot;);

// Begin running the instance, which will be terminated remotely by the KillSwitch.
match inst.run(&quot;infinite_loop&quot;, &amp;[]) {
    Err(Error::RuntimeTerminated(TerminationDetails::Remote)) =&gt; {
        // the result of a guest that was remotely terminated (a KillSwitch at work)
    }
    res =&gt; panic!(&quot;unexpected result: {:?}&quot;, res),
}

// wait for the KillSwitch-firing thread to complete
t.join().unwrap();
<span class="boring">}
</span></code></pre></pre>
<h2><a class="header" href="#implementation" id="implementation">Implementation</a></h2>
<p>As this section discusses implementation details of <code>lucet_runtime</code>, it will
refer to structures and enums that are unexported. For most components of
Lucet's <code>KillSwitch</code> functionality, defintions live in
<code>lucet-runtime-internals/src/instance/execution.rs</code>.</p>
<p><code>KillState</code> and <code>Domain</code>, around which most of the implementation is centered,
are both defined here and are internal to Lucet. As a result, fully qualified
paths such as <code>instance::execution::Domain</code> may be used below and not have
corresponding entries visible in rustdoc - these items exist in the crate
source though!</p>
<p>As much as is possible, <code>KillSwitch</code> tries to be self-contained; no members are
public, and it tries to avoid leaking details of its state-keeping into public
interfaces. Currently, <code>lucet-runtime</code> is heavily dependent on POSIX
thread-directed signals to implement guest termination. For non-POSIX platforms
alternate implementations may be plausible, but need careful consideration of
the race conditions that can arise from other platform-specific functionality.</p>
<p><code>KillSwitch</code> fundamentally relies on two pieces of state for safe operation,
which are encapsulated in a <code>KillState</code> held by the <code>Instance</code> it terminates:</p>
<ul>
<li><code>execution_domain</code>, a <code>Domain</code> that describes the kind of execution that is
currently happening in the <code>Instance</code>.
<ul>
<li>This is kept in a <code>Mutex</code> since in many cases it will need to be accessed
either by a <code>KillSwitch</code> or <code>KillState</code>, both of which must block other
users while they are considering the domain.</li>
</ul>
</li>
<li><code>terminable</code>, an <code>AtomicBool</code> that indicates if the <code>Instance</code> may stop
executing.
<ul>
<li><code>terminable</code> is in some ways a subset of the information expressed by
<code>Domain</code>. It is true if and only if the instance is not obligated to a
specific exit mechanism yet, which could be determined by examing the
active <code>Domain</code> at points we check <code>terminable</code> instead. Even though this
is duplicative, it is necessary for a correct implementation when POSIX
signal handlers are involved, because it is extremely inadvisable to take
locks in a signal handler. While a <code>Mutex</code> can be dangerous, we can share
an <code>AtomicBool</code> in signal-safety-constrained code with impunity! See the
section <code>Timeout while handling a guest fault</code> for more details on working
under this constraint.</li>
</ul>
</li>
</ul>
<p>The astute observer may notice that <code>Lucet</code> contains both an instance <code>Domain</code>
and an instance <code>State</code>. These discuss different aspects of the instance's
lifecycle: <code>Domain</code> describes what the instance is doing right now, where
<code>State</code> describes the state of the instance as visible outside <code>lucet_runtime</code>.
This is fundamentally the reason why <code>State</code> does not and cannot describe a
&quot;making a hostcall&quot; variant - this is not something <code>lucet_runtime</code> wants to
expose, and at the moment we don't intend to make any commitments about being
able to query instance-internal state like this.</p>
<p>Additionally, this is why <code>Domain::Terminated</code> only expresses that an instance
has <em>stopped</em> running, not if it successfully or unsuccessfully exited. From
<code>Domain</code>'s perspective, the instance has stopped running, and that's all there
is to it. The <code>Instance</code>'s <code>State</code> will describe how the instance stopped, and
if that's by a return or a fault.</p>
<h3><a class="header" href="#termination-mechanisms" id="termination-mechanisms">Termination Mechanisms</a></h3>
<p>At a high level,<code>KillSwitch</code> picks one of several mechanisms to terminate an
instance. The mechanism selected depends on the instance's current <code>Domain</code>:</p>
<p><code>Domain::Guest</code> is likely to be the most common termination form.
<code>lucet_runtime</code> will send a thread-directed <code>SIGARLM</code> to the thread running the
Lucet instance that currently is in guest code.</p>
<p><code>Domain::Hostcall</code> results in the mechanism with least guarantees:
<code>lucet_runtime</code> can't know if it's safe to signal in arbitrary host-provided
code[1]. Instead, we set the execution domain to <code>Domain::Terminated</code> and wait
for the host code to complete, at which point <code>lucet_runtime</code> will exit the
guest.</p>
<p><code>Domain::Pending</code> is the easiest domain to stop execution in: we simply update
the execution domain to <code>Cancelled</code>. In <code>enter_guest_region</code>, we see that the
instance is no longer eligible to run and exit before handing control to the
guest.</p>
<p>Other variants of <code>Domain</code> imply an instance state where there is no possible
termination mechanism. <code>Domain::Terminated</code> indicates that the instance has
already been terminated, and <code>Domain::Cancelled</code> indicates that the instance
has already been preemptively stopped.</p>
<h4><a class="header" href="#guest-signalling" id="guest-signalling">Guest Signalling</a></h4>
<p>There are two other pieces of information attached to <code>KillState</code> that support
the specific case where we need to send a <code>SIGALRM</code>: the thread ID we need to
signal, and a <a href="https://doc.rust-lang.org/1.40.0/std/sync/struct.Condvar.html"><code>Condvar</code></a> we can wait on to know when the instance has
been stopped.</p>
<p>The thread ID is necessary because we don't record <em>where</em> the instance is
running anywhere else. We keep it here because, so far, <code>KillState</code> is the only
place we actually need to care. <code>Condvar</code> allows <code>lucet_runtime</code> to avoid a
spin loop while waiting for signal handling machinery to actually terminate an
<code>Instance</code> in <code>Domain::Guest</code>.</p>
<h3><a class="header" href="#lifecycle" id="lifecycle">Lifecycle</a></h3>
<p>Having described both <code>KillState</code> and the termination mechanisms it helps
select, we can discuss the actual lifecycle of the <code>KillState</code> for a call into
an <code>Instance</code> and see how these pieces begin to fit together.</p>
<p>Because <code>KillState</code> only describes one call into an instance, an <code>Instance</code> may
have many <code>KillState</code> over its lifetime. Even so, at one <em>specific</em> time there
is only one <code>KillState</code>, which describes the current, or imminent, call into
the instance.</p>
<p>Execution of a Lucet <code>Instance</code> begins with a default <code>KillState</code>: in the
<code>Pending</code> domain, <code>terminable</code> set to <code>true</code>, with no <code>thread_id</code> as it is not
currently running.  When a call is made to <code>Instance::run</code>, the <code>Instance</code>'s
bootstrap context is set up and <code>KillState::schedule</code> is called to set up
last-minute state before the instance begins running.</p>
<p><code>lucet_runtime</code> shortly thereafter will switch to the <code>Instance</code> and begin
executing its bootstrapping code. In <code>enter_guest_region</code> the guest will lock
and update the execution domain to <code>Guest</code>, or see the instance is
<code>Domain::Cancelled</code> and exit. If the instance could run, we proceed into the
AOT-compiled Wasm.</p>
<p>At some point, the instance will likely make a hostcall to embedder-provided or
<code>lucet_runtime</code>-provided code; correctly-implemented hostcalls are wrapped in
<code>begin_hostcall</code> and <code>end_hostcall</code> to take care of runtime bookkeeping,
including updating <code>execution_domain</code> to <code>Domain::Hostcall</code> (<code>begin_hostcall</code>)
and afterwards checking that the instance can return to guest code, setting
<code>execution_domain</code> back to <code>Domain::Guest</code> (<code>end_hostcall</code>).</p>
<p>At some point the instance will hopefully exit, where in
<code>lucet_context_backstop</code> we check that the instance may stop exiting
(<code>KillState::terminable</code>). If it can exit, then do so. Finally, back in
<code>lucet_runtime</code>, we can <code>KillState::deschedule</code> to tear down the last of the
run-specific state - the <code>thread_id</code>.</p>
<h2><a class="header" href="#implementation-complexities-when-you-have-a-scheduler-full-of-demons" id="implementation-complexities-when-you-have-a-scheduler-full-of-demons">Implementation Complexities (When You Have A Scheduler Full Of Demons)</a></h2>
<p>Many devils live in the details. The rest of this chapter will discuss the
numerous edge cases and implementation concerns that Lucet's asynchronous
signal implementation must consider, and arguments for its correctness in the
face of these.</p>
<p>First, a flow chart of the various states and their transitions:
<img src="lucet-runtime/states.png" alt="state flow chart" /></p>
<p>This graph describes the various states that reflect values of
<code>execution_domain</code> and <code>terminable</code> for those states, with edges describing
transitions between domains including termination in non-race scenarios. The
rest of this section discusses the correctness of termination at boundaries
where these state transitions occur.</p>
<p>For reference later, the possible state transitions are:</p>
<ul>
<li><code>A -&gt; B</code> (instance runs guest code)</li>
<li><code>A -&gt; D</code> (KillSwitch fires before instance runs)</li>
<li><code>B -&gt; C</code> (guest makes a hostcall)</li>
<li><code>B -&gt; E</code> (normal guest exit)</li>
<li><code>B -&gt; E</code> (from a guest fault/termination)</li>
<li><code>C -&gt; B</code> (hostcall returns to guest)</li>
<li><code>C -&gt; E</code> (hostcall terminates instance)</li>
<li><code>C -&gt; E</code> (hostcall observes termination)
<ul>
<li>not an internal state but we will also discuss termination during a hostcall fault</li>
</ul>
</li>
<li><code>D -&gt; E</code> (cancelled guest is run)</li>
</ul>
<p>These will be covered in rough order of complexity, starting with the simplest
cases and ending with the race which has shown itself to have the most corners.
Races involving <code>Domain::Guest</code> tend to be trickiest, and consequently are
further down.</p>
<h3><a class="header" href="#a---d---termination-before-instance-runs" id="a---d---termination-before-instance-runs"><code>A -&gt; D</code> - Termination before instance runs</a></h3>
<p>This is a timeout while another <code>KillSwitch</code> has already fired, timing out a
guest before exeuction. Because another <code>KillSwitch</code> must have fired for there
to be a race, one of the two will acquire <code>terminable</code> and actually update
<code>execution_domain</code>, while the other simply exits.</p>
<h3><a class="header" href="#d---e---termination-when-cancelled-guest-is-run" id="d---e---termination-when-cancelled-guest-is-run"><code>D -&gt; E</code> - Termination when cancelled guest is run</a></h3>
<p>Terminating a previously cancelled guest will have no effect - termination must
have occurred already, so the <code>KillSwitch</code> that fired will not acquire
<code>terminable</code>, and will return without ceremony.</p>
<h3><a class="header" href="#c---b---termination-when-hostcall-returns-to-guest" id="c---b---termination-when-hostcall-returns-to-guest"><code>C -&gt; B</code> - Termination when hostcall returns to guest</a></h3>
<p>The case of a <code>KillSwitch</code> firing while exiting from a hostcall is very similar
to termination while entering a hostcall.</p>
<p>The <code>KillSwitch</code> might observe a guest in <code>Domain::Guest</code>, prohibit a state
change, and signal the guest. Alternatively, the <code>KillSwitch</code> can observe the
guest in <code>Domain::Hostcall</code> and update the guest to <code>Domain::Terminated</code>. In
the latter case, the guest will be free to run when the <code>KillSwitch</code> returns,
at which point it will have the same behavior as termination in any
hostcall.</p>
<h3><a class="header" href="#c---e---termination-during-hostcall-terminating-instance" id="c---e---termination-during-hostcall-terminating-instance"><code>C -&gt; E</code> - Termination during hostcall terminating instance</a></h3>
<p>The <code>KillSwitch</code> that fires acquires <code>terminable</code> and then attempts to acquire
a lock on <code>execution_domain</code>. The <code>KillSwitch</code> will see <code>Domain::Hostcall</code>, and
will update to <code>Domain::Terminated</code>. The shared <code>KillState</code> will be not used by
<code>lucet_runtime</code> again in the future, because after returning to the host it
will be replaced by a new <code>KillState</code>.</p>
<h3><a class="header" href="#c---e---termination-repeatedly-during-hostcall" id="c---e---termination-repeatedly-during-hostcall"><code>C -&gt; E</code> - Termination repeatedly during hostcall</a></h3>
<p>Termination while a hostcall is already observing an earlier termination will
have no effect. The <code>KillSwitch</code> that fired last will not acquire
<code>terminable</code>, and will return without ceremony.</p>
<h3><a class="header" href="#b---c---termination-when-guest-makes-a-hostcall" id="b---c---termination-when-guest-makes-a-hostcall"><code>B -&gt; C</code> - Termination when guest makes a hostcall</a></h3>
<p>If a <code>KillSwitch</code> fires during a transition from guest (B) to hostcall (C) code,
there are two circumstances also contingent on whether the instance has
switched to <code>Domain::Hostcall</code>.</p>
<h4><a class="header" href="#before-switching-to-domainhostcall" id="before-switching-to-domainhostcall">Before switching to <code>Domain::Hostcall</code></a></h4>
<p>The <code>KillSwitch</code> that fires locks <code>execution_domain</code> and sees the execution
domain is <code>Domain::Guest</code>. It then uses typical guest termination macinery and
signals the guest. An important correctness subtlety here is that <code>KillSwitch</code>
holds the <code>execution_domain</code> lock until the guest is terminated, so the guest
cannot simultaneously proceed into hostcall code and receieve a stray
<code>SIGALRM</code>.</p>
<h4><a class="header" href="#after-switching-to-domainhostcall" id="after-switching-to-domainhostcall">After switching to <code>Domain::Hostcall</code></a></h4>
<p>The <code>KillSwitch</code> that fires acquires <code>terminable</code> and then attempts to acquire
a lock on <code>execution_domain</code>. Because the instance is switching to or has
switched to <code>Domain::Hostcall</code>, the <code>KillSwitch</code> will select the termination
style for hostcalls. It will update the execution domain to
<code>Domain::Terminated</code> and the instance will return when the hostcall exits and
the <code>Terminated</code> domain is observed.</p>
<h3><a class="header" href="#a---b---termination-while-entering-guest-code" id="a---b---termination-while-entering-guest-code"><code>A -&gt; B</code> - Termination while entering guest code</a></h3>
<p>If a <code>KillSwitch</code> fires between instance initialization (A) and the start of
guest execution (B), there are two circumstances to consider: does the
termination occur before or after the Lucet instance has switched to
<code>Domain::Guest</code>?</p>
<h4><a class="header" href="#before-switching-to-domainguest" id="before-switching-to-domainguest">Before switching to <code>Domain::Guest</code></a></h4>
<p>The <code>KillSwitch</code> that fires acquires <code>terminable</code> and then locks
<code>execution_domain</code> to determine the appropriate termination  mechanism.  This is
before the instance has locked it in <code>enter_guest_region</code>, so it will acquire
the lock, with a state of <code>Domain::Pending</code>. Seeing a pending instance, the
<code>KillSwitch</code> will update it to <code>Domain::Cancelled</code> and release the lock, at
which point the instance will acquire the lock, observe the instance is
<code>Cancelled</code>, and return to the host without executing any guest code.</p>
<h4><a class="header" href="#after-switching-to-domainguest" id="after-switching-to-domainguest">After switching to <code>Domain::Guest</code></a></h4>
<p>The <code>KillSwitch</code> that fires acquires <code>terminable</code> and then attempts to acquire
a lock on <code>execution_domain</code> to determine the appropriate termination mechanism.
Because the instance has already locked <code>execution_domain</code> to update it to
<code>Domain::Guest</code>, this blocks until the instance releases the lock (and guest
code is running).  At this point, the instance is running guest code and it is
safe for the <code>KillSwitch</code> to operate as if it were terminating any other guest
code - with the same machinery as an instance in state <code>B</code> (a <code>SIGALRM</code>).</p>
<h3><a class="header" href="#b---e---termination-during-normal-guest-exit" id="b---e---termination-during-normal-guest-exit"><code>B -&gt; E</code> - Termination during normal guest exit</a></h3>
<p>The <code>KillSwitch</code> that fires attempts to acquire <code>terminable</code>, but is in a race
with the teardown in <code>lucet_context_backstop</code>. Both functions attempt to swap
<code>false</code> into <code>terminable</code>, but only one will see <code>true</code> out of it. This acts as
an indicator for which function may continue, where the other may have to take
special care as to not leave the instance in a state that would be dangerous to
signal.</p>
<h4><a class="header" href="#guest-acquires-terminable" id="guest-acquires-terminable">Guest acquires <code>terminable</code></a></h4>
<p>The guest exits in the next handful of instructions. The <code>KillSwitch</code> that
failed to acquire the <code>true</code> in <code>terminable</code> exits with an indication that it
could not terminate the guest. In this circunstance, we are certain that there
is a non-conditional and short path out of the guest comprising a return from
<code>exit_guest_region</code> and a context swap back to the host code. Timeouts
&quot;failing&quot; due to this are only failing because the guest is about to exit, and
a signal would have no interesting additional benefit.</p>
<h4><a class="header" href="#killswitch-acquires-terminable" id="killswitch-acquires-terminable"><code>KillSwitch</code> acquires <code>terminable</code></a></h4>
<p>In a more unfortunate circumstance, the <code>KillSwitch</code> is what observed the
<code>true</code> out of <code>terminable</code>. In this case, the guest observed <code>false</code> and must
not proceed, so that whenever an imminent <code>SIGALRM</code> from the corresponding
<code>KillSwitch</code> arrives, it will be in a guaranteed-to-be-safe spin loop, or on
its way there with only signal-safe state.</p>
<p>The <code>KillSwitch</code> itself will signal the guest as any other <code>Domain::Guest</code>
interruption.</p>
<h3><a class="header" href="#b---e---termination-during-guest-fault-or-terminated-twice" id="b---e---termination-during-guest-fault-or-terminated-twice"><code>B -&gt; E</code> - Termination during guest fault, or terminated twice</a></h3>
<p>In this sub-section we assume that the Lucet signal handler is being used, and
will discuss the properties <code>KillSwitch</code> requires from any signal handler for
correctness.</p>
<p>The <code>KillSwitch</code> that fires attempts to acquire <code>terminable</code>. Because a guest
fault or termination has occurred, the guest is actually in
<code>lucet_runtime_internals::instance::signals::handle_signal</code>. If termination
occurs while the guest is already responding to a previous <code>KillSwitch</code>'s
termination, the second <code>KillSwitch</code> will see <code>terminable</code> of <code>false</code> and
quickly exit.  Otherwise, <code>terminable</code> is <code>true</code> and we have to handle...</p>
<h4><a class="header" href="#terminated-while-handling-a-guest-fault" id="terminated-while-handling-a-guest-fault">Terminated while handling a guest fault</a></h4>
<p>In the case that a <code>KillSwitch</code> fires during a guest fault, the <code>KillSwitch</code> may
acquire <code>terminable</code>. POSIX signal handlers are highly constrained, see <code>man 7 signal-safety</code> for details. The functional constraint imposed on signal
handlers used with Lucet is that they may not lock on <code>KillState</code>'s
<code>execution_domain</code>.</p>
<p>As a consequence, a <code>KillSwitch</code> may fire during the handling of a guest fault.
<code>sigaction</code> must mask <code>SIGALRM</code> so that a signal fired before the handler exits
does not preempt the handler. If the signal behavior is to continue without
effect, leave termination in place and continue to the guest. A pending SIGALRM
will be raised at this point and the instance will exit. Otherwise, the signal
handler has determined it must return to the host, and must be sensitive to a
possible in-flight <code>KillSwitch</code>...</p>
<h4><a class="header" href="#instance-stopping-guest-fault-with-concurrent-killswitch" id="instance-stopping-guest-fault-with-concurrent-killswitch">Instance-stopping guest fault with concurrent <code>KillSwitch</code></a></h4>
<p>In this case we must consider three constraints:</p>
<ul>
<li>A <code>KillSwitch</code> may fire and deliver a <code>SIGALRM</code> at any point</li>
<li>A <code>SIGALRM</code> may already have been fired, pending on the handler returning</li>
<li>The signal handler must return to host code</li>
</ul>
<p>First, we handle the risk of a <code>KillSwitch</code> firing: disable termination. If we
acquire <code>terminable</code>, we know this is to the exclusion of any <code>KillSwitch</code>, and
are safe to return. Otherwise, some <code>KillSwitch</code> has terminated, or is in the
process of terminating, this guest's execution. This means a <code>SIGALRM</code> may be
pending or imminent!</p>
<p>A slightly simpler model is to consider that a <code>SIGALRM</code> may arrive in the
future. This way, for correctness we only have to make sure we handle the
signal we can be sent! We know that we must return to the host, and the guest
fault that occurred is certainly more interesting than the guest termination,
so we would like to preserve that information. There is no information or
effect we want from the signal, so silence the alarm on <code>KillState</code>. This way,
if we recieve the possible <code>SIGARLM</code>, we know to ignore it.</p>
<p>An important question to ask is &quot;How do we know the possible <code>SIGARLM</code> must be
ignored? Could it not be for another instance later on that thread?&quot; The answer
is, in short, &quot;We ensure it cannot!&quot;</p>
<p>The <code>SIGARLM</code> is thread-directed, so to be an alarm for some other reason,
another instance would have to run and be terminated. To prevent this, we must
prevent another instance from running. Additionally, if a <code>SIGALRM</code> is <em>in
flight</em>, we need to stop and wait anyway. Since <code>KillSwitch</code> maintains a lock
on <code>execution_domain</code> as long as it's attempting to terminate a guest, we can
achieve both of these goals by taking, and immediately dropping, a lock on
<code>execution_domain</code> before descheduling an instance.</p>
<p>Even taking this lock is interesting:</p>
<ol start="0">
<li>This lock could be taken while racing a <code>KillSwitch</code>, after it has observed it may fire but before advancing to take this lock.</li>
<li>This lock could be taken while racing a <code>KillSwitch</code>, after it has taken this lock.</li>
<li>This lock could be taken without racing a <code>KillSwitch</code>.</li>
</ol>
<p>In the first case, we've won a race on <code>execution_domain</code>, but there might be a
<code>KillSwitch</code> we're blocking with this. Disarm the <code>KillSwitch</code> by updating the
domain to <code>Terminated</code>, which reflects the fact that this instance has exited.</p>
<p>In the second case, descheduling until the <code>KillSwitch</code> has completed
termination. The domain will be <code>Terminated</code>, and updating to <code>Terminated</code> has
no effect. We simply use this lock to prevent continuting into the host until
an in-flight <code>KillSwitch</code> completes.</p>
<p>In the third case, we're not racing a <code>KillSwitch</code>, and any method of exiting
the guest will have disabled termination. No <code>KillSwitch</code> will observe a
changed <code>execution_domain</code>, so it's not incorrect to update it to <code>Terminated</code>.</p>
<p>Taken together, this ensures that descheduling an instance serializes in-flight
<code>KillSwitch</code> or prevents one from taking effect in a possibly-incorrect way, so
we know this race is handled correctly.</p>
<h3><a class="header" href="#terminated-in-hostcall-fault" id="terminated-in-hostcall-fault">Terminated in hostcall fault</a></h3>
<p>As promised, a note about what happens when a timeout occurs directly when a
hostcall faults! The instance's <code>execution_domain</code> must be <code>Domain::Hostcall</code>,
as it's a hostcall that faulted. The <code>KillSwitch</code> may or may not fire before
the signal handler disables termination. Even if it does fire, it will lock the
shared <code>execution_domain</code> and see <code>Domain::Hostcall</code>, where the domain will be
updated to <code>Domain::Terminated</code>.  Since the hostcall will not resume,
<code>end_hostcall</code> will never see that the instance should stop, and no further
effect will be had; regardless of <code>KillSwitch</code> effect, the instance will exit
through the signal handler with a <code>Faulted</code> state. Additionally, because
faulted instances cannot be resumed, <code>end_hostcall</code> will never witness the
timeout.</p>
<p>[1]: For example, the code we would <em>like</em> to interrupt may hold locks, which we
can't necessarily guarantee drop. In a non-locking example, the host code could
be resizing a <code>Vec</code> shared outside that function, where interrupting the resize
could yield various forms of broken behavior.</p>
<h1><a class="header" href="#lucet-wasi---a-hrefhttpsdocsrslucet-wasiimg-srchttpsdocsrslucet-wasibadgesvg-altdocs-badge-a" id="lucet-wasi---a-hrefhttpsdocsrslucet-wasiimg-srchttpsdocsrslucet-wasibadgesvg-altdocs-badge-a"><code>lucet-wasi</code>   <a href="https://docs.rs/lucet-wasi"><img src="https://docs.rs/lucet-wasi/badge.svg" alt="docs-badge" /></a></a></h1>
<p><code>lucet-wasi</code> is a crate providing runtime support for the <a href="https://wasi.dev">WebAssembly System Interface
(WASI)</a>.  It can be used as a library to support WASI in another application, or
as an executable, <code>lucet-wasi</code>, to execute WASI programs compiled through <code>lucetc</code>.</p>
<p>Example WASI programs are in the <a href="examples"><code>examples</code></a> directory.</p>
<h2><a class="header" href="#example-1" id="example-1">Example</a></h2>
<pre><code class="language-sh">lucet-wasi example.so --dir .:. --max-heap-size 2GiB -- example_arg
</code></pre>
<h2><a class="header" href="#usage-1" id="usage-1">Usage</a></h2>
<pre><code class="language-text">    lucet-wasi [OPTIONS] &lt;lucet_module&gt; [--] [guest_args]...

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

OPTIONS:
        --entrypoint &lt;entrypoint&gt;                         Entrypoint to run within the WASI module [default: _start]
        --heap-address-space &lt;heap_address_space_size&gt;
            Maximum heap address space size (must be a multiple of 4 KiB, and &gt;= `max-heap-size`) [default: 8 GiB]

        --max-heap-size &lt;heap_memory_size&gt;
            Maximum heap size (must be a multiple of 4 KiB) [default: 4 GiB]

        --dir &lt;preopen_dirs&gt;...                           A directory to provide to the WASI guest
        --stack-size &lt;stack_size&gt;
            Maximum stack size (must be a multiple of 4 KiB) [default: 8 MiB]


ARGS:
    &lt;lucet_module&gt;     Path to the `lucetc`-compiled WASI module
    &lt;guest_args&gt;...    Arguments to the WASI `main` function
</code></pre>
<h2><a class="header" href="#preopened-files-and-directories" id="preopened-files-and-directories">Preopened files and directories</a></h2>
<p>By default, WASI doesn't allow any access to the filesystem. Files and directories must be
explicitly allowed by the host.</p>
<p>Instead of directly accessing the filesystem using paths, an instance will use inherited descriptors
from pre-opened files.</p>
<p>This means that even the current directory cannot be accessed by a WebAssembly instance, unless this
has been allowed with:</p>
<pre><code class="language-text">--dir .:.
</code></pre>
<p>This maps the current directory <code>.</code> as seen by the WebAssembly module to <code>.</code> as seen on the host.</p>
<p>Multiple <code>--dir &lt;wasm path&gt;:&lt;host path&gt;</code> arguments can be used in order to allow the instance to
access more paths.</p>
<p>Along with a preopened file/directory, WASI stores a set of capabilities. Lucet currently sets all
the capabilities. In particular, once a directory has been preopened, its content as well as files
from any of its subdirectories can be accessed as well.</p>
<h2><a class="header" href="#maximum-heap-size" id="maximum-heap-size">Maximum heap size</a></h2>
<p><code>--heap-address-space</code> controls the maximum allowed heap size.</p>
<p>Usually, this should match the <code>--reserved-size</code> value given to <code>lucetc</code>.</p>
<h2><a class="header" href="#supported-syscalls" id="supported-syscalls">Supported syscalls</a></h2>
<p>We support the entire <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-api.md">WASI
API</a>, with the exception of
socket-related syscalls. These will be added when network access is standardized.</p>
<h2><a class="header" href="#thread-safety" id="thread-safety">Thread safety</a></h2>
<p>Lucet guests are currently single-threaded only. The WASI embedding assumes this, and so the syscall
implementations are not thread-safe. This is not a fundamental limitation, should Lucet support
multi-threaded guests in the future.</p>
<h1><a class="header" href="#lucet-objdump" id="lucet-objdump"><code>lucet-objdump</code></a></h1>
<p><code>lucet-objdump</code> is a Rust executable for inspecting the contents of a shared object generated by
<code>lucetc</code>.</p>
<h2><a class="header" href="#usage-2" id="usage-2">Usage</a></h2>
<pre><code class="language-sh">lucet-objdump &lt;lucetc-compiled-shared-object&gt;
</code></pre>
<p><code>lucetc-objdump</code> prints details about a shared object producted by <code>lucetc</code>:</p>
<ul>
<li>Required symbols</li>
<li>Exported functions and symbols</li>
<li>Imported functions and symbols</li>
<li>Heap specification</li>
<li>Globals specification</li>
<li>Data segments</li>
<li>Sparse page data</li>
<li>Trap manifest</li>
</ul>
<p>This can be useful for debugging purposes.</p>
<p><img src="https://user-images.githubusercontent.com/49215183/58720565-5ae08d00-8387-11e9-8b38-49dcb12e20d2.png" alt="lucet-objdump" /></p>
<h1><a class="header" href="#lucet-spectest" id="lucet-spectest"><code>lucet-spectest</code></a></h1>
<p><code>lucet-spectest</code> is a Rust crate that uses <code>lucetc</code> and <code>lucet-runtime</code>, as well as the (external)
<code>wabt</code> crate, to run the official WebAssembly spec test suite, which is provided as a submodule in
this directory.</p>
<p>Lucet is not yet fully spec compliant, however reaching spec compliance is part of our project
roadmap.</p>
<h1><a class="header" href="#lucet-wasi-sdk---a-hrefhttpsdocsrslucet-wasi-sdkimg-srchttpsdocsrslucet-wasi-sdkbadgesvg-altdocs-badge-a" id="lucet-wasi-sdk---a-hrefhttpsdocsrslucet-wasi-sdkimg-srchttpsdocsrslucet-wasi-sdkbadgesvg-altdocs-badge-a"><code>lucet-wasi-sdk</code>   <a href="https://docs.rs/lucet-wasi-sdk"><img src="https://docs.rs/lucet-wasi-sdk/badge.svg" alt="docs-badge" /></a></a></h1>
<p><a href="https://github.com/cranestation/wasi-sdk"><code>wasi-sdk</code></a> is a Cranelift project that packages a build
of the Clang toolchain, the WASI reference sysroot, and a libc based on WASI syscalls.</p>
<p><code>lucet-wasi-sdk</code> is a Rust crate that provides wrappers around these tools for building C programs
into Lucet modules. We use this crate to build test cases in <code>lucet-runtime-tests</code> and <code>lucet-wasi</code>.</p>
<h1><a class="header" href="#lucet-module---a-hrefhttpsdocsrslucet-moduleimg-srchttpsdocsrslucet-modulebadgesvg-altdocs-badge-a" id="lucet-module---a-hrefhttpsdocsrslucet-moduleimg-srchttpsdocsrslucet-modulebadgesvg-altdocs-badge-a"><code>lucet-module</code>   <a href="https://docs.rs/lucet-module"><img src="https://docs.rs/lucet-module/badge.svg" alt="docs-badge" /></a></a></h1>
<p><code>lucet-module</code> is a crate with data structure definitions and serialization functions that we emit
into shared objects with <code>lucetc</code>, and read with <code>lucet-runtime</code>.</p>
<h1><a class="header" href="#tests-and-benchmarks" id="tests-and-benchmarks">Tests and benchmarks</a></h1>
<p>Most of the crates in this repository have some form of unit tests. In addition,
<code>lucet-runtime/lucet-runtime-tests</code> defines a number of integration tests for the runtime, and
<code>lucet-wasi</code> has a number of integration tests using WASI C programs.</p>
<p>We also created the <a href="./sightglass.html">Sight Glass</a> benchmarking tool to measure the runtime of C
code compiled through a standard native toolchain against the Lucet toolchain. It is provided as a
submodule at <code>/sightglass</code>.</p>
<p>Sightglass ships with a set of microbenchmarks called <code>shootout</code>. The scripts to build the shootout
tests with native and various versions of the Lucet toolchain are in <code>/benchmarks/shootout</code>.</p>
<p>Furthermore, there is a suite of benchmarks of various Lucet runtime functions, such as instance
creation and teardown, in <code>/benchmarks/lucet-benchmarks</code>.</p>
<h2><a class="header" href="#adding-new-tests-for-crates-other-than-lucet-runtime-or-lucet-runtime-internals" id="adding-new-tests-for-crates-other-than-lucet-runtime-or-lucet-runtime-internals">Adding new tests for crates other than <code>lucet-runtime</code> or <code>lucet-runtime-internals</code></a></h2>
<p>Most of the crates in this repository are tested in the usual way, with a mix of unit tests defined
alongside the modules they test, and integration tests defined in separate test targets.</p>
<p>Note that <code>lucetc</code> and <code>lucet-wasi-sdk</code> provide library interfaces for the Wasm compiler and the
C-to-Wasm cross compiler, respectively. You should prefer using these interfaces in a test to using
the command-line tools directly with <code>std::process:Command</code>, a Makefile, or a shell script.</p>
<h2><a class="header" href="#adding-new-tests-for-lucet-runtime-or-lucet-runtime-internals" id="adding-new-tests-for-lucet-runtime-or-lucet-runtime-internals">Adding new tests for <code>lucet-runtime</code> or <code>lucet-runtime-internals</code></a></h2>
<p>While these crates have a similar mix of unit and integration tests, there are some additional
complications to make sure the public interface is well-tested, and to allow reuse of tests across
backends.</p>
<h3><a class="header" href="#public-interface-tests" id="public-interface-tests">Public interface tests</a></h3>
<p>The tests defined in <code>lucet-runtime</code> and <code>lucet-runtime-tests</code> are meant to exclusively test the
public interface exported from <code>lucet-runtime</code>. This is to ensure that the public interface is
sufficiently expressive to use all of the features we want to expose to users, and to catch linking
problems as early as possible.</p>
<p>While some tests in these crates use APIs exported only from <code>lucet-runtime-internals</code>, this is only
for test scaffolding or inspection of results. The parts of the test that are &quot;what the user might
do&quot; should only be defined in terms of <code>lucet-runtime</code> APIs.</p>
<h3><a class="header" href="#test-reuse-regions-and-macros" id="test-reuse-regions-and-macros">Test reuse, regions, and macros</a></h3>
<p>Many of the tests in the runtime require the use of a <code>lucet_runtime::Region</code> in order to create
Lucet instances. To enable reuse of these tests across multiple <code>Region</code> implementations, many tests
are defined in macros. For example, the unit tests defined in
<code>/lucet-runtime/lucet-runtime-internals/src/alloc/tests.rs</code> are parameterized by a <code>TestRegion</code>
argument, which is then applied using <code>crate::region::mmap::MmapRegion</code>. Likewise, many of the
integration tests in <code>/lucet-runtime/lucet-runtime-tests</code> are defined using macros that take a
<code>TestRegion</code>.</p>
<p>Most tests that use a <code>Region</code> should be defined within a macro like this. The exception is for
tests that are specific to a particular region implementation, likely using an API that is not part
of the <code>Region</code> trait. These tests should be defined alongside the implementation of the region (for
unit tests) or directly in a <code>lucet-runtime</code> test target (for integration tests).</p>
<h1><a class="header" href="#sight-glass" id="sight-glass">Sight Glass</a></h1>
<p>Sight Glass is a benchmark suite and tool to compare different implementations of the same primitives.</p>
<h2><a class="header" href="#usage-3" id="usage-3">Usage</a></h2>
<p>Sight Glass loads multiple shared libraries implementing the same test suite, runs all tests from all suites, and produces reports to evaluate how implementations compare to each other.</p>
<p>Functions from each library are evaluated as follows:</p>
<pre><code class="language-c">tests_config.global_setup(&amp;global_ctx);

  test1_setup(global_ctx, &amp;test1_ctx);
  test1_body(test1_ctx);
  test1_teardown(test1_ctx);

  test2_setup(global_ctx, &amp;test2_ctx);
  test2_body(test2_ctx);
  test2_teardown(test2_ctx);

  // ...

  testN_setup(global_ctx, &amp;testN_ctx);
  testN_body(testN_ctx);
  testN_teardown(testN_ctx);

tests_config.global_teardown(global_ctx);
</code></pre>
<p>Each shared library must export a <code>tests_config</code> symbol:</p>
<pre><code class="language-c">typedef struct TestsConfig {
    void     (*global_setup)(void **global_ctx_p);
    void     (*global_teardown)(void *global_ctx);
    uint64_t version;
} TestsConfig;

TestsConfig tests_config;
</code></pre>
<p><code>global_setup</code> and <code>global_teardown</code> are optional, and can be set to <code>NULL</code> if not required.</p>
<p>A test must at least export a function named <code>&lt;testname&gt;_body</code>:</p>
<pre><code class="language-c">void testname_body(void *ctx);
</code></pre>
<p>This function contains the actual code to be benchmarked.</p>
<p>By default, <code>ctx</code> will be set to the <code>global_ctx</code>. However, optional <code>setup</code> and <code>teardown</code> functions can also be provided for individual tests:</p>
<pre><code class="language-c">void testname_setup(void *global_ctx, void **ctx_p);

void testname_teardown(void *ctx);
</code></pre>
<p>See <code>example/example.c</code> for an example test suite.</p>
<p>Sightglass extracts all symbols matching the above convention to define and run the test suite.</p>
<h2><a class="header" href="#running-multiple-functions-for-a-single-test" id="running-multiple-functions-for-a-single-test">Running multiple functions for a single test</a></h2>
<p>A single test can evaluate multiple body functions sharing the same context.</p>
<p>These functions have to be named <code>&lt;testname&gt;_body_&lt;bodyname&gt;</code>.</p>
<p><code>&lt;bodyname&gt;</code> can be anything; a numeric ID or a short description of the purpose of the function.</p>
<pre><code class="language-c">void testname_body_2(void *ctx);
void testname_body_randomized(void *ctx);
</code></pre>
<p>These functions are guaranteed to be evaluated according to their names sorted in lexical order.</p>
<h2><a class="header" href="#configuration" id="configuration">Configuration</a></h2>
<p>The global configuration is loaded from <code>sightglass.toml</code> file. This can be changed using the <code>-c</code> command-line flag.</p>
<p>The configuration lists implementations to be benchmarked:</p>
<pre><code class="language-toml">test_suites = [
  { name = &quot;test1&quot;, library_path = &quot;implementation1.so&quot; },
  { name = &quot;test2&quot;, library_path = &quot;implementation2.so&quot; }
]
</code></pre>
<p>Individual test suites can also run a command in order to be optionally skipped if that command returns a non-zero exit code:</p>
<pre><code class="language-toml">test_suites = [
  { name = &quot;test1&quot;, library_path = &quot;implementation1.so&quot; },
  { name = &quot;test2&quot;, library_path = &quot;implementation2.so&quot;, guard = [&quot;/opt/sg/guard-scripts/check&quot;, &quot;arg1&quot;, &quot;arg2&quot;] }
]
</code></pre>
<p>Additional properties that the file can include:</p>
<ul>
<li>
<p><code>single_core = &lt;bool&gt;</code>: set to <code>true</code> in order to run the tests on a single CPU core, in order to get more accurate results. This only works on Linux.</p>
</li>
<li>
<p><code>output = [ { format = &quot;Text|CSV|JSON&quot; [, file = &lt;file&gt;] [, breakdown = &lt;bool&gt;] } ... ]</code>: how to store or display the results.</p>
</li>
</ul>
<p>By defaut, the <code>Text</code> and <code>CSV</code> output do not include a breakdown of the time spent in individual functions for tests made of multiple functions.
This can be changed with the optional <code>breakdown</code> property being set to <code>true</code>.</p>
<p>The <code>JSON</code> output always includes this information.</p>
<h1><a class="header" href="#versioning-and-releasing-to-cratesio" id="versioning-and-releasing-to-cratesio">Versioning and releasing to crates.io</a></h1>
<p>This document describes how to appropriately decide the version of a new release, and the steps to
actually get it published on crates.io.</p>
<h2><a class="header" href="#versioning" id="versioning">Versioning</a></h2>
<p>We release new versions of the Lucet crates all at once, keeping the versions in sync across
crates. As a result, our adherence to <a href="https://semver.org/">semver</a> is project-wide, rather than
per-crate.</p>
<p>The versioning reflects the semantics of the <em>public</em> interface to Lucet. That is, any breaking
change to the following crates requires a semver major version bump:</p>
<ul>
<li><code>lucetc</code></li>
<li><code>lucet-objdump</code></li>
<li><code>lucet-runtime</code></li>
<li><code>lucet-validate</code></li>
<li><code>lucet-wasi</code></li>
<li><code>lucet-wasi-sdk</code></li>
</ul>
<p>For the other Lucet crates that are primarily meant for internal consumption, a breaking change does
<em>not</em> inherently require a semver major version bump unless either:</p>
<ol>
<li>The changed interfaces are reexported as part of the public interface via the above crates, or</li>
<li>The binary format of a compiled Lucet module is changed.</li>
</ol>
<p>For example, a change to the type of <a href="https://docs.rs/lucet-runtime-internals/latest/lucet_runtime_internals/instance/struct.Instance.html#method.run"><code>Instance::run()</code></a> would require a major
version bump, but a change to the type of <a href="https://docs.rs/lucet-runtime-internals/latest/lucet_runtime_internals/instance/trait.InstanceInternal.html#tymethod.alloc"><code>InstanceInternal::alloc()</code></a> would not.</p>
<p>Likewise, a change to a field on <a href="https://docs.rs/lucet-module/latest/lucet_module/struct.ModuleData.html"><code>ModuleData</code></a> would require a major version bump, as
it would change the serialized representation in a compiled Lucet module.</p>
<h2><a class="header" href="#the-release-process" id="the-release-process">The release process</a></h2>
<p>The release process for a normal (non-hotfix) release consists of several phases:</p>
<ol>
<li>
<p><a href="versioning_releasing.html#preparing-the-release-commit">Preparing the release commit</a></p>
</li>
<li>
<p><a href="versioning_releasing.html#releasing-to-cratesio">Releasing to crates.io</a></p>
</li>
<li>
<p><a href="versioning_releasing.html#tagging-and-annotating-the-release-in-git">Tagging and annotating the release in Git</a></p>
</li>
<li>
<p><a href="versioning_releasing.html#merging-the-release-commit">Merging the release commit</a></p>
</li>
</ol>
<h3><a class="header" href="#preparing-the-release-commit" id="preparing-the-release-commit">Preparing the release commit</a></h3>
<p><strong>Note</strong> This is a new practice since we've introduced the practice of <code>-dev</code> versions and the
changelog, and is expected to be refined as we get more experience with it.</p>
<ol>
<li>
<p>Determine the version for the new release (see <a href="versioning_releasing.html#versioning">Versioning</a>).</p>
</li>
<li>
<p>Create a new release branch based on the commit you want to eventually release. For example:</p>
<pre><code class="language-shell">$ git checkout -b 0.5.2-release origin/main
</code></pre>
</li>
<li>
<p>Replace the development version with the final version in the crates' <code>Cargo.toml</code> files. For
example, <code>0.5.2-dev</code> should become <code>0.5.2</code>. Run the test suite in order to make sure <code>Cargo.lock</code>
is up to date.</p>
</li>
<li>
<p>Edit <code>CHANGELOG.md</code> to add a new header with the version number and date of release.</p>
</li>
<li>
<p>Commit, then open a pull request for the release and mark it with the <strong>DO NOT MERGE</strong> label.</p>
</li>
<li>
<p>Secure review and approval from the Lucet team for the pull request.</p>
</li>
</ol>
<p>At this point, you should have a commit on your release branch that you are prepared to release to
crates.io. Do not merge the pull request yet! Instead, proceed to <a href="versioning_releasing.html#releasing-to-cratesio">release</a>
the crates.</p>
<h3><a class="header" href="#releasing-to-cratesio" id="releasing-to-cratesio">Releasing to crates.io</a></h3>
<p>Releasing a workspace full of interdependent crates can be challenging. Crates must be published in
the correct order, and any cyclic dependencies that might be introduced via <code>[dev-dependencies]</code>
must be broken. While there is <a href="https://github.com/rust-lang/cargo/issues/4242">interest in making this smoother</a>, for now we have
to muddle through more manually.</p>
<ol>
<li>
<p>Authenticate with <code>cargo login</code> using a Github account with the appropriate access to the Lucet
repository. You should only have to do this once per development environment.</p>
</li>
<li>
<p>Ensure that you have the commit checked out that you would like to release.</p>
</li>
<li>
<p>Ensure that the version in all of the Lucet <code>Cargo.toml</code> files matches the version you expect to
release. Between releases, the versions will end in <code>-dev</code>; if this is still the case, you'll
need to replace this version with the appropriate version according to the guidelines above,
likely through a PR.</p>
</li>
<li>
<p>Edit <code>lucet-validate/Cargo.toml</code> and make the following change (note the leading <code>#</code>):</p>
<pre><code class="language-diff"> [dev-dependencies]
-lucet-wasi-sdk = { path = &quot;../lucet-wasi-sdk&quot;, version = &quot;=0.5.2&quot; }
+#lucet-wasi-sdk = { path = &quot;../lucet-wasi-sdk&quot;, version = &quot;=0.5.2&quot; }
 tempfile = &quot;3.0&quot;
</code></pre>
<p>This breaks the only cycle that exists among the crates as of <code>0.5.1</code>; if other cycles develop,
you'll need to similarly break them by temporarily removing the dev dependency.</p>
</li>
<li>
<p>Begin publishing the crates in a topological order by <code>cd</code>ing to the each crate and running
<code>cargo publish --allow-dirty</code> (the tree should only be dirty due to the cycles broken
above). While we would like to run <code>cargo publish --dry-run</code> beforehand to ensure all
of the crates will be successfully published, this will fail for any crates that depend on other
Lucet crates, as the new versions will not yet be available to download.</p>
<p>Do not worry too much about calculating the order ahead of time; if you get it wrong, <code>cargo publish</code> will tell you which crates need to be published before the one you tried. An order which
worked for the <code>0.5.1</code> release was:</p>
<ol>
<li><code>lucet-module</code></li>
<li><code>lucet-validate</code></li>
<li><code>lucetc</code></li>
<li><code>lucet-wasi-sdk</code></li>
<li><code>lucet-objdump</code></li>
<li><code>lucet-runtime-macros</code></li>
<li><code>lucet-runtime-internals</code></li>
<li><code>lucet-runtime-tests</code></li>
<li><code>lucet-runtime</code></li>
<li><code>lucet-wasi</code></li>
</ol>
<p>It is unlikely but not impossible that a publish will fail in the middle of this process, leaving
some of the crates published but not others. What to do next will depend on the situation; please
consult with the Lucet team.</p>
</li>
<li>
<p>Ensure the new crates have been published by checking for matching version tags on the <a href="https://crates.io/search?q=lucet">Lucet
crates</a>.</p>
</li>
</ol>
<p>Congratulations, the new crates are now on crates.io! 🎉</p>
<h3><a class="header" href="#tagging-and-annotating-the-release-in-git" id="tagging-and-annotating-the-release-in-git">Tagging and annotating the release in Git</a></h3>
<ol>
<li>
<p>Undo any changes in your local tree to break cycles.</p>
</li>
<li>
<p>Tag the release; <code>--sign</code> is optional but recommended if you have code signing configured:</p>
<pre><code class="language-shell">$ git tag --annotate --sign -m '0.5.2 crates.io release' 0.5.2
$ git push --tags
</code></pre>
</li>
<li>
<p>Browse to this version's tag on the Github <a href="https://github.com/bytecodealliance/lucet/tags">tags page</a>, click <strong>Edit tag</strong>, and then
paste this release's section of <code>CHANGELOG.md</code> into the description. Enter a title like <code>0.5.2 crates.io release</code>, and then click <strong>Publish release</strong>.</p>
</li>
</ol>
<h3><a class="header" href="#merging-the-release-commit" id="merging-the-release-commit">Merging the release commit</a></h3>
<ol>
<li>
<p>Edit the versions in the repo once more, this time to the next patch development version. For
example, if we just released <code>0.5.2</code>, change the version to <code>0.5.3-dev</code>.</p>
</li>
<li>
<p>Commit, remove the <strong>DO NOT MERGE</strong> tag from your release PR, and seek final approval from the
Lucet team.</p>
</li>
<li>
<p>Merge the release PR, and make sure the release branch is deleted. The release <em>tag</em> will not be
deleted, and will be the basis for any future hotfix releases that may be required.</p>
</li>
</ol>
<h1><a class="header" href="#lucet-security-overview" id="lucet-security-overview">Lucet security overview</a></h1>
<p>This document provides a high-level summary of the security architecture of the Lucet project. It is meant to be used for orientation and a starting point for deploying a secure embedding of Lucet.</p>
<h2><a class="header" href="#security-model" id="security-model">Security model</a></h2>
<p>The Lucet project aims to provide support for secure execution of untrusted code. The project does not provide a complete secure sandbox framework at this time; security is achieved through a combination of Lucet-supplied security controls and user-supplied security controls.</p>
<p>At a high level, this jointly-constructed security architecture aims to prevent untrusted input, data, and activity from compromising the security of trusted components. It also aims to prevent an untrusted actor from compromising the security (e.g. data and activity) of another untrusted actor. For example, one user of a Lucet embedding should not be able to affect the security of another user of the same Lucet embedding.</p>
<p>Some security requirements for the Lucet project have not been implemented yet. See the remainder of this document as well as <a href="https://github.com/bytecodealliance/lucet/issues">project Github issues</a> for more information. Note that even when Lucet project security goals have been met, overall system security requirements will vary by embedding.</p>
<p>The Lucet security model can be summarized via two simplified execution scenarios: compiling/loading of sandboxed guest code and execution of untrusted guest programs. These scenarios are described in terms of the following levels.</p>
<ul>
<li>Trusted: refers to code, processes, or inputs that are fully trusted and generally controlled by the administrator of a system that runs or embeds Lucet components.</li>
<li>Untrusted: refers to code, processes, or inputs that are completely untrusted and generally supplied by a third party. For example, user-supplied Wasm code is untrusted.</li>
</ul>
<p>The scenarios are modeled as simplified data flow diagrams below. <a href="https://draw.io">draw.io</a> diagram source files are available <a href="assets/lucet_dfds.xml">here</a>.</p>
<h3><a class="header" href="#compileload-scenario" id="compileload-scenario">Compile/load scenario</a></h3>
<p><img src="assets/security_dfd_cl.png" alt="" /></p>
<p>In the compile/load scenario, a user provides untrusted WebAssembly code to the <a href="https://github.com/bytecodealliance/lucet/tree/main/lucetc"><code>lucetc</code></a> compiler. The <code>lucetc</code> compiler consumes this code along with trusted bindings and produces a shared object file. A trusted application (e.g. server) that embeds <code>lucet-runtime</code> then loads the guest program.</p>
<h3><a class="header" href="#program-execution-scenario" id="program-execution-scenario">Program execution scenario</a></h3>
<p><img src="assets/security_dfd_pe.png" alt="" /></p>
<p>In the program execution scenario, an untrusted third party end-user sends data to a trusted server that has loaded a guest program (via the compile/load scenario above). The trusted server handles this data and passes it to an instance of the untrusted guest program for processing. The guest program may call into trusted server APIs to perform privileged processing, such as further communication with the end-user, untrusted network endpoints, etc. before execution terminates.</p>
<h2><a class="header" href="#security-requirements" id="security-requirements">Security requirements</a></h2>
<p>This section summarizes salient security requirements for the Lucet projects in terms of high-level attack scenarios. As mentioned above, Lucet does not provide a complete secure sandbox framework at this time; security is achieved through a combination of Lucet-supplied security controls and user-supplied security controls.</p>
<h3><a class="header" href="#attacks-against-compilation-process" id="attacks-against-compilation-process">Attacks against compilation process</a></h3>
<p>An attacker may be able to supply a malicious input file to the <code>lucetc</code> compiler toolchain in the context of the “compile/load” scenario above, with a goal of compromising <code>lucetc</code> and/or the host system it is executing within.</p>
<p>Lucet is designed to prevent elevation of privilege attacks and against the <code>lucetc</code> compiler toolchain. Due to the nature of WebAssembly application, upstream components of the <code>lucetc</code> compiler (particularly <a href="https://github.com/bytecodealliance/cranelift">Cranelift</a>) generally have a similar design goals in this respect, and have corresponding security measures in place. The Lucet project has undergone an initial security assessment.</p>
<p>Bugs in <code>lucetc</code> that can lead to information leaks, elevation of privilege (e.g. arbitrary remote code execution) and otherwise compromise security attributes are considered security vulnerabilities in the context of the Lucet project.</p>
<p>Attack vectors stemming from asymmetric consumption of resources inherent in compilation processes, for example consumption of CPU or memory for large or complex inputs, should be addressed by user/administrator via environmental controls or similar. For example, a <code>lucetc</code> deployment could limit input size earlier in the processing flow, include cgroup runtime controls, etc.</p>
<p>Note that an evolving compiler toolchain like <code>lucetc</code> presents a rich attack surface that will likely require ongoing patching of vulnerabilities. It is highly recommended that additional protections common classes of attacks be deployed by administrators for defense-in-depth. For example, the <a href="https://wasm.fastlylabs.com/">terrarium project</a> runs <code>lucetc</code> compilation jobs in minimal, single-use, security-hardened containers in an isolated environment subject to runtime security monitoring.</p>
<h3><a class="header" href="#guest-to-host-attacks" id="guest-to-host-attacks">Guest-to-host attacks</a></h3>
<p>An attacker can supply malicious guest code to a Lucet embedding. Bugs in <code>lucetc</code>, <code>lucet-runtime</code>, or any other project components that allow code generated by an attacker to elevate privileges against the embedding host, crash the host, leak host data, or otherwise compromise the host’s security are considered security vulnerabilities. Correspondingly, bugs in Lucet that compromise of security policies of system components (e.g. <a href="https://github.com/bytecodealliance/wasmtime/blob/main/docs/WASI-overview.md">WASI capabilities policies</a>) are considered security vulnerabilities.</p>
<p>Lucet leverages WebAssembly semantics, control flow, and operational memory isolation models to prevent broad classes of attacks against the host embedding (see the <a href="https://webassembly.org/docs/security/">WebAssembly docs</a> for details). Specifically, Lucet provides WebAssembly-based mechanisms for isolating most faults to a specific instance of guest program; in these cases mitigations can be applied (e.g. alerting, guest banning, etc.) and execution of the host process can continue unabated. Lucet is compatible with the <a href="https://wasi.dev">WebAssembly System Interface (WASI)</a> API for system interfaces, which supplies a capabilities-based security model for system resource access. Lucet is designed to provide a baseline for integration with additional host sandboxing technologies, such as seccomp-bpf.</p>
<p>Host function call bindings supplied by the Lucet user/administrator are analogous to WebAssembly imported functions. Lucet project components aim to generate code that provides ABI-level consistency checking of function call arguments (work in progress), but vulnerabilities explicitly defined in host-side functionality supplied by Lucet administrators (e.g. memory corruption in an embedding server’s C code) is considered out-of-scope for the Lucet project.</p>
<h4><a class="header" href="#caveats" id="caveats">Caveats</a></h4>
<ul>
<li>Lucet does not provide complete protection against transient/speculative execution attacks against the host. Efforts are underway in <code>lucetc</code> and upstream projects to supply industry-standard protections to generated native code, but Lucet users/administrators must deploy additional defenses, such as protecting imported function APIs from speculative execution, applying privilege separation, <a href="https://www.chromium.org/Home/chromium-security/site-isolation">site isolation</a>, <a href="https://wiki.mozilla.org/Security/Sandbox/Seccomp#Intro_to_seccomp_and_seccomp-bpf">sandboxing technology</a> and so on.</li>
<li>Support for automated ABI-level consistency checking of function call arguments is not complete. In the meantime, Lucet users/administrators must implement this checking.</li>
<li>Lucet is a new technology and under active development. Designers and architects should plan to monitor releases and regularly patch Lucet to benefit from remediation of security vulnerabilities.</li>
</ul>
<h3><a class="header" href="#guest-to-guest-attacks" id="guest-to-guest-attacks">Guest-to-guest attacks</a></h3>
<p>This scenario is similar to the previous one, except an attacker is targeting another guest. Similarly, bugs in <code>lucetc</code>, <code>lucet-runtime</code>, or any other project components that allow code generated by an attacker to leak data of other guest or other compromise the security of other guests are considered vulnerabilities.</p>
<p>The protections, responsibilities, and caveats defined in the previous section apply to this attack scenario as well.</p>
<h3><a class="header" href="#attacks-against-guest-programs" id="attacks-against-guest-programs">Attacks against guest programs</a></h3>
<p>An attacker may attempt to exploit a victim guest program that is executing in a Lucet host embedding. Lucet provides WebAssembly-based security guarantees for guest programs, but WebAssembly programs may still be vulnerable to exploitation. For example, memory allocated within a linear memory region <a href="https://00f.net/2018/11/25/webassembly-doesnt-make-unsafe-languages-safe/">may not have conventional protections in place</a>, <a href="https://www.fastly.com/blog/hijacking-control-flow-webassembly">type confusion</a> or <a href="https://i.blackhat.com/us-18/Thu-August-9/us-18-Lukasiewicz-WebAssembly-A-New-World-of-Native_Exploits-On-The-Web-wp.pdf">other basic memory corruption vulnerabilities</a> that are not obviated by WebAssembly may be present in guest programs, and so on. It is the Lucet administrator’s responsibility to protect vulnerable guest program logic beyond WebAssembly-provided safety measures.</p>
<h2><a class="header" href="#report-a-security-issue" id="report-a-security-issue">Report a security issue</a></h2>
<p>See the project's <a href="../../SECURITY.html">SECURITY.md</a></p>
<h1><a class="header" href="#changelog" id="changelog">Changelog</a></h1>
<h3><a class="header" href="#unreleased" id="unreleased">Unreleased</a></h3>
<ul>
<li>
<p>Added <code>install_lucet_signal_handler()</code> and <code>remove_lucet_signal_handler()</code>, along with <code>Instance::ensure_signal_handler_installed()</code> and <code>Instance::ensure_sigstack_installed()</code> options to control the automatic installation and removal of signal handlers and alternate signal stacks. The default behaviors have not changed.</p>
</li>
<li>
<p>Added <code>Instance::run_start()</code> to the public API, which runs the <a href="https://webassembly.github.io/spec/core/syntax/modules.html#syntax-start">Wasm start function</a> if it is present in that instance's Wasm module. It does nothing if there is no start function.</p>
<p>Creating or resetting an instance no longer implicitly runs the start function. Embedders must ensure that <code>run_start()</code> is called before calling any other exported functions. <code>Instance::run()</code> will now return <code>Err(Error::InstanceNeedsStart)</code> if the start function is present but hasn't been run since the instance was created or reset.</p>
</li>
<li>
<p>Encoded the <a href="https://webassembly.github.io/spec/core/syntax/modules.html#syntax-start">Wasm start function</a> in Lucet module metadata, rather than as a specially-named symbol in the shared object. This reduces contention from <code>dlsym</code> operations when multiple threads run Lucet instances concurrently.</p>
</li>
<li>
<p>Upgraded the <code>libloading</code> dependency, allowing for more specific error messages from dynamic loading operations.</p>
</li>
<li>
<p>Corrected a race condition where a <code>KillSwitch</code> fired while lucet-runtime is handling a guest fault could result in a SIGALRM or panic in the Lucet embedder.</p>
</li>
<li>
<p>Converted the <code>&amp;mut Vmctx</code> argument to hostcalls into <code>&amp;Vmctx</code>. Additionally, all <code>Vmctx</code> methods now take <code>&amp;self</code>, where some methods such as <code>yield</code> previously took <code>&amp;mut self</code>. These methods still require that no other outstanding borrows (such as the heap view) are held across them, but that property is checked dynamically rather than at compile time.</p>
</li>
</ul>
<h3><a class="header" href="#061-2020-02-18" id="061-2020-02-18">0.6.1 (2020-02-18)</a></h3>
<ul>
<li>
<p>Added metadata to compiled modules that record whether instruction counting instrumentation is present.</p>
</li>
<li>
<p>Made <code>lucetc</code> more flexible in its interpretation of the <code>LD</code> environment variable. It now accepts a space-separated set of tokens; the first token specifies the program to invoke, and the remaining tokens specifying arguments to be passed to that program. Thanks, @froydnj!</p>
</li>
<li>
<p>Added public <code>LucetcOpt</code> methods to configure the <code>canonicalize_nans</code> setting. Thanks, @roman-kashitsyn!</p>
</li>
<li>
<p>Fixed <code>lucet-runtime</code>'s use of CPUID to not look for extended features unless required by the module being loaded, avoiding a failure on older CPUs where that CPUID leaf is not present. Thanks, @shravanrn!</p>
</li>
</ul>
<h3><a class="header" href="#060-2020-02-05" id="060-2020-02-05">0.6.0 (2020-02-05)</a></h3>
<ul>
<li>
<p>Added <code>free_slots()</code>, <code>used_slots()</code>, and <code>capacity()</code> methods to the <code>Region</code> trait.</p>
</li>
<li>
<p>Added a check to ensure the <code>Limits</code> signal stack size is at least <code>MINSIGSTKSZ</code>, and increased the default signal stack size on macOS debug builds to fit this constraint.</p>
</li>
<li>
<p>Added an option to canonicalize NaNs to the <code>lucetc</code> API. Thanks, @DavidM-D!</p>
</li>
<li>
<p>Restored some of the verbosity of pretty-printed errors in <code>lucetc</code> and <code>lucet-validate</code>, with more on the way.</p>
</li>
<li>
<p>Fixed OS detection for LDFLAGS on macOS. Thanks, @roman-kashitsyn!</p>
</li>
</ul>
<h3><a class="header" href="#051-2020-01-24" id="051-2020-01-24">0.5.1 (2020-01-24)</a></h3>
<ul>
<li>Fixed a memory corruption bug that could arise in certain runtime configurations. (<a href="https://github.com/bytecodealliance/lucet/pull/401">PR</a>) (<a href="https://rustsec.org/advisories/RUSTSEC-2020-0004.html">RustSec advisory</a>)</li>
</ul>
<h3><a class="header" href="#050-2020-01-24" id="050-2020-01-24">0.5.0 (2020-01-24)</a></h3>
<ul>
<li>
<p>Lucet officially became a project of the <a href="https://bytecodealliance.org/">Bytecode Alliance</a> 🎉.</p>
</li>
<li>
<p>Integrated <code>wasi-common</code> as the underlying implementation for WASI in <code>lucet-wasi</code>.</p>
</li>
<li>
<p>Updated to Cranelift to version 0.51.0.</p>
</li>
<li>
<p>Fixed a soundness bug by changing the types of the <code>Vmctx::yield*()</code> methods to require exclusive <code>&amp;mut self</code> access to the <code>Vmctx</code>. This prevents resources like embedder contexts or heap views
from living across yield points, which is important for safety since the host can modify the data underlying those resources while the instance is suspended.</p>
</li>
<li>
<p>Added the <code>#[lucet_hostcall]</code> attribute to replace <code>lucet_hostcalls!</code>, which is now deprecated.</p>
</li>
<li>
<p>Added the ability to specify an alignment for the base of a <code>MmapRegion</code>-backed instance's heap. Thanks, @shravanrn!</p>
</li>
<li>
<p>Added a <code>--target</code> option to <code>lucetc</code> to allow cross-compilation to other architectures than the host's. Thanks, @froydnj!</p>
</li>
<li>
<p>Changed the Cargo dependencies between Lucet crates to be exact (e.g., <code>&quot;=0.5.0&quot;</code> rather than <code>&quot;0.5.0&quot;</code>) rather than allowing semver differences.</p>
</li>
<li>
<p>Fixed the <code>KillSwitch</code> type not being exported from the public API, despite being usable via <code>Instance::kill_switch()</code>.</p>
</li>
<li>
<p>Improved the formatting of error messages.</p>
</li>
<li>
<p>Ensured the <code>lucet-wasi</code> executable properly links in the exported symbols from <code>lucet-runtime</code>.</p>
</li>
</ul>
<h3><a class="header" href="#043-2020-01-24" id="043-2020-01-24">0.4.3 (2020-01-24)</a></h3>
<ul>
<li>Backported the fix for a memory corruption bug that could arise in certain runtime configurations. (<a href="https://github.com/bytecodealliance/lucet/pull/401">PR</a>) (<a href="https://rustsec.org/advisories/RUSTSEC-2020-0004.html">RustSec advisory</a>)</li>
</ul>
<pre><code class="language-text">
                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      &quot;License&quot; shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      &quot;Licensor&quot; shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      &quot;Legal Entity&quot; shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      &quot;control&quot; means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      &quot;You&quot; (or &quot;Your&quot;) shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      &quot;Source&quot; form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      &quot;Object&quot; form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      &quot;Work&quot; shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      &quot;Derivative Works&quot; shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      &quot;Contribution&quot; shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, &quot;submitted&quot;
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as &quot;Not a Contribution.&quot;

      &quot;Contributor&quot; shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a &quot;NOTICE&quot; text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an &quot;AS IS&quot; BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets &quot;[]&quot;
      replaced with your own identifying information. (Don't include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same &quot;printed page&quot; as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.


--- LLVM Exceptions to the Apache 2.0 License ----

As an exception, if, as a result of your compiling your source code, portions
of this Software are embedded into an Object form of such source code, you
may redistribute such embedded portions in such Object form without complying
with the conditions of Sections 4(a), 4(b) and 4(d) of the License.

In addition, if you combine or link compiled forms of this Software with
software that is licensed under the GPLv2 (&quot;Combined Software&quot;) and if a
court of competent jurisdiction determines that the patent provision (Section
3), the indemnity provision (Section 9) or other Section of the License
conflicts with the conditions of the GPLv2, you may retroactively and
prospectively choose to deem waived or otherwise exclude such Section(s) of
the License, but only in their entirety and only with respect to the Combined
Software.

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
